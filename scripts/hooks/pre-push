#!/bin/sh
set -e

ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"
if [ -z "$ROOT" ]; then
  echo "pre-push: unable to locate repo root" >&2
  exit 1
fi
cd "$ROOT"

if ! command -v docker >/dev/null 2>&1; then
  echo "pre-push: docker is required to run git-warp CLI bats tests" >&2
  exit 1
fi

echo "Running pre-push link check..."
if command -v lychee >/dev/null 2>&1; then
  lychee --config .lychee.toml '**/*.md'
else
  echo "  skipped (lychee not installed â€” brew install lychee)"
fi

# Run lint + typecheck + policy in parallel (all are read-only)
echo "Running pre-push lint + typecheck + policy (parallel)..."
npm run lint &
LINT_PID=$!
npm run typecheck &
TC_PID=$!
npm run typecheck:policy &
POLICY_PID=$!
wait $LINT_PID || { echo "Lint failed"; exit 1; }
wait $TC_PID || { echo "Typecheck failed"; exit 1; }
wait $POLICY_PID || { echo "TS policy check failed"; exit 1; }

# Build Docker image once, reuse for tests + benchmarks + BATS
echo "Building Docker test image..."
docker compose build test

echo "Running pre-push unit tests..."
docker compose run --no-build --rm test npm run test:local
echo "Running pre-push benchmarks..."
docker compose run --no-build --rm test npm run benchmark:local
echo "Running pre-push git-warp CLI bats tests..."
docker compose run --no-build --rm test bats test/bats/
