#!/bin/sh
set -e

ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"
if [ -z "$ROOT" ]; then
  echo "pre-push: unable to locate repo root" >&2
  exit 1
fi
cd "$ROOT"

echo "Running pre-push link check..."
if command -v lychee >/dev/null 2>&1; then
  lychee --config .lychee.toml '**/*.md'
else
  echo "  skipped (lychee not installed â€” brew install lychee)"
fi

# Run lint + typecheck + policy + consumer type test in parallel (all are read-only)
echo "Running pre-push lint + typecheck + policy + consumer type test (parallel)..."
npm run lint &
LINT_PID=$!
npm run typecheck &
TC_PID=$!
npm run typecheck:policy &
POLICY_PID=$!
npm run typecheck:consumer &
CONSUMER_PID=$!
wait $LINT_PID || { echo "Lint failed"; exit 1; }
wait $TC_PID || { echo "Typecheck failed"; exit 1; }
wait $POLICY_PID || { echo "TS policy check failed"; exit 1; }
wait $CONSUMER_PID || { echo "Consumer type test failed"; exit 1; }

echo "Running pre-push unit tests..."
npm run test:local

# Docker builds, benchmarks, and BATS E2E tests run in CI only
