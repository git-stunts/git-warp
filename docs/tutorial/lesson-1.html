<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lesson 1: The Ghost in the Machine</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@hpcc-js/wasm/dist/index.min.js" type="javascript/worker"></script>
  <script src="https://cdn.jsdelivr.net/npm/@hpcc-js/wasm/dist/index.min.js"></script>
</head>
<body>
  <header>
    <h1>CHRONOS CLASH</h1>
    <a href="index.html" style="color: var(--text-2); text-decoration: none;">&larr; BACK TO HUB</a>
  </header>

  <main id="app">
    <section class="card">
      <h2>Lesson 1: The Ghost in the Machine</h2>
      <p>Standard databases use files. SQL uses <code>.db</code>, MongoDB uses <code>.data</code>. But in <strong>Chronos Clash</strong>, we use <strong>Ghost Storage</strong>.</p>
      
      <p>We store our story nodes in Git commits, but we point them to the <strong>Empty Tree</strong>. This means they are invisible to your filesystem, but safely tucked away in Git's object database.</p>

      <div class="card">
        <h3>Interactive Simulation</h3>
        <p>Click the button to "commit" a story node. Watch how the Git commit structure grows, even though your directory remains empty!</p>
        
        <button @click="addNode" class="btn-primary">CREATE STORY NODE</button>
        
        <div class="viz-container" id="viz">
          <!-- Graphviz goes here -->
        </div>

        <div v-if="history.length > 0">
          <h4>Commit Log:</h4>
          <pre><code>{{ log }}</code></pre>
        </div>
      </div>

      <div class="lesson-nav">
        <a href="index.html" class="btn-primary" style="background: var(--surface-3);">PREVIOUS</a>
        <a href="lesson-2.html" class="btn-primary">NEXT: THE WORLDLINE &rarr;</a>
      </div>
    </section>
  </main>

  <script>
    const { createApp } = Vue
    const hpccWasm = window["@hpcc-js/wasm"];

    createApp({
      data() {
        return {
          nodes: [],
          history: [],
          emptyTree: "4b825dc..."
        }
      },
      computed: {
        log() {
          return this.history.map(h => `COMMIT ${h.sha}
Tree: ${this.emptyTree}
Message: ${h.msg}
`).join('
')
        }
      },
      methods: {
        addNode() {
          const id = this.nodes.length + 1;
          const sha = Math.random().toString(16).substring(2, 10);
          const msg = `Story Node #${id}: The journey begins...`;
          
          this.nodes.push({ id, sha });
          this.history.unshift({ sha, msg });
          this.renderGraph();
        },
        async renderGraph() {
          let dot = `digraph G {
            bgcolor="transparent";
            node [shape=box, style=filled, fillcolor="#334155", fontcolor="white", fontname="Inter"];
            edge [color="#94a3b8"];
            
            EmptyTree [label="Empty Tree
(4b825dc...)", fillcolor="#1e293b", shape=cylinder];
          `;

          this.nodes.forEach((n, i) => {
            dot += `Node${n.id} [label="Commit: ${n.sha}
Payload: Story #${n.id}"];
`;
            dot += `Node${n.id} -> EmptyTree [label="points to"];
`;
            if (i > 0) {
              dot += `Node${n.id} -> Node${this.nodes[i-1].id} [label="parent"];
`;
            }
          });

          dot += "}";
          
          const vizElement = document.getElementById("viz");
          const svg = await hpccWasm.graphviz.layout(dot, "svg", "dot");
          vizElement.innerHTML = svg;
        }
      },
      mounted() {
        this.renderGraph();
      }
    }).mount('#app')
  </script>
</body>
</html>
