<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lesson 4: X-Ray Vision</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@hpcc-js/wasm/dist/index.min.js"></script>
</head>
<body>
  <header>
    <h1>CHRONOS CLASH</h1>
    <a href="index.html" style="color: var(--text-2); text-decoration: none;">&larr; BACK TO HUB</a>
  </header>

  <main id="app">
    <section class="card">
      <h2>Lesson 4: X-Ray Vision (Indexing)</h2>
      <p>As our story grows to millions of nodes, walking the Git commit history becomes slow. To keep <strong>Chronos Clash</strong> fast, we need "X-Ray Vision".</p>
      
      <p>We build a secondary <strong>Bitmap Index</strong> using <strong>Roaring Bitmaps</strong>. These are highly compressed bitsets that allow us to ask questions like "Who are the neighbors of Node X?" in O(1) time.</p>
      
      <p>The index is stored right alongside the graph in Git as sharded JSON blobs, allowing for lazy loading. You only pay for what you query.</p>

      <div class="card">
        <h3>Index Simulation</h3>
        <p>Generate a large graph and watch how the Bitmap Index maps SHAs to compact integer IDs for lightning-fast lookup.</p>
        
        <button @click="generateMassiveGraph" class="btn-primary">GENERATE 100 NODES</button>
        
        <div class="viz-container" id="viz"></div>

        <div class="card" v-if="indexData.length > 0">
          <h4>Bitmap Index Fragment (meta_ab.json):</h4>
          <pre><code>{{ indexJson }}</code></pre>
        </div>
      </div>

      <div class="lesson-nav">
        <a href="lesson-3.html" class="btn-primary" style="background: var(--surface-3);">PREVIOUS</a>
        <a href="index.html" class="btn-primary">MISSION COMPLETE: BACK TO HUB &rarr;</a>
      </div>
    </section>
  </main>

  <script>
    const { createApp } = Vue
    const hpccWasm = window["@hpcc-js/wasm"];

    createApp({
      data() {
        return {
          indexData: [],
          nodes: []
        }
      },
      computed: {
        indexJson() {
          const obj = {
            version: 2,
            checksum: "sha256-...",
            data: {}
          };
          this.indexData.forEach(d => obj.data[d.sha] = d.id);
          return JSON.stringify(obj, null, 2);
        }
      },
      methods: {
        generateMassiveGraph() {
          this.nodes = [];
          this.indexData = [];
          for (let i = 0; i < 100; i++) {
            const sha = Math.random().toString(16).substring(2, 10);
            this.nodes.push({ id: i, sha });
            if (i < 5) {
              this.indexData.push({ id: i, sha });
            }
          }
          this.renderGraph();
        },
        async renderGraph() {
          let dot = `digraph G {
            layout=twopi;
            bgcolor="transparent";
            node [shape=point, color="#334155", width=0.1];
            edge [color="#94a3b8", arrowsize=0.5];
          `;

          for (let i = 0; i < this.nodes.length; i++) {
            const next = (i + 1) % this.nodes.length;
            const randomJump = (i + Math.floor(Math.random() * 10)) % this.nodes.length;
            dot += `N${i} -> N${next};
`;
            if (i % 5 === 0) dot += `N${i} -> N${randomJump};
`;
          }

          dot += "}";
          
          const vizElement = document.getElementById("viz");
          const svg = await hpccWasm.graphviz.layout(dot, "svg", "twopi");
          vizElement.innerHTML = svg;
        }
      },
      mounted() {
        // Initial small graph
        this.nodes = [{id: 0, sha: "abc1234"}];
        this.renderGraph();
      }
    }).mount('#app')
  </script>
</body>
</html>
