// Fig 8. Hexagonal Architecture
// Style: Architectural — concentric layers
// Shows: Domain core → Ports → Adapters with inward-only dependencies

digraph architecture {
  bgcolor=transparent
  fontname="Times-Roman"
  fontsize=11
  label=<<I>Fig. 8.  Hexagonal Architecture — dependency rule: arrows point inward only</I>>
  labelloc=b
  labeljust=c

  node [fontname="Times-Roman", fontsize=9, penwidth=0.8]
  edge [fontname="Times-Roman", fontsize=8, penwidth=0.8]

  // === Outer ring: Adapters ===
  subgraph cluster_adapters {
    label=<<B>Adapters</B>  (infrastructure implementations)>
    labelloc=t
    style=rounded
    color="#606060"
    penwidth=0.8
    fillcolor="#f0f0f0"
    fontname="Times-Roman"
    fontsize=9

    git_adapter [shape=box, style="rounded,filled", fillcolor="#f0f0f0",
                 label=<GitGraphAdapter<BR/><FONT POINT-SIZE="7">@git-stunts/plumbing</FONT>>]
    cbor_codec [shape=box, style="rounded,filled", fillcolor="#f0f0f0",
                label=<CborCodec<BR/><FONT POINT-SIZE="7">cbor-x</FONT>>]
    web_crypto [shape=box, style="rounded,filled", fillcolor="#f0f0f0",
                label=<WebCryptoAdapter<BR/><FONT POINT-SIZE="7">globalThis.crypto</FONT>>]
    clock_adapter [shape=box, style="rounded,filled", fillcolor="#f0f0f0",
                   label=<ClockAdapter<BR/><FONT POINT-SIZE="7">globalThis.performance</FONT>>]
    console_log [shape=box, style="rounded,filled", fillcolor="#f0f0f0",
                 label=<ConsoleLogger>]
    cas_cache [shape=box, style="rounded,filled", fillcolor="#f0f0f0",
               label=<CasSeekCacheAdapter>]

    // === Middle ring: Ports ===
    subgraph cluster_ports {
      label=<<B>Ports</B>  (abstract interfaces)>
      labelloc=t
      style=rounded
      color="#606060"
      penwidth=0.8
      fontname="Times-Roman"
      fontsize=9

      persistence_port [shape=box, style="dashed,filled", fillcolor="#d0d0d0",
                        label="GraphPersistencePort"]
      codec_port [shape=box, style="dashed,filled", fillcolor="#d0d0d0",
                  label="CodecPort"]
      crypto_port [shape=box, style="dashed,filled", fillcolor="#d0d0d0",
                   label="CryptoPort"]
      clock_port [shape=box, style="dashed,filled", fillcolor="#d0d0d0",
                  label="ClockPort"]
      logger_port [shape=box, style="dashed,filled", fillcolor="#d0d0d0",
                   label="LoggerPort"]
      index_port [shape=box, style="dashed,filled", fillcolor="#d0d0d0",
                  label="IndexStoragePort"]
      cache_port [shape=box, style="dashed,filled", fillcolor="#d0d0d0",
                  label="SeekCachePort"]

      // === Inner core: Domain ===
      subgraph cluster_domain {
        label=<<B>Domain Core</B>>
        labelloc=t
        style="rounded,filled"
        fillcolor="#e8e8e8"
        color="#606060"
        penwidth=1.0
        fontname="Times-Roman"
        fontsize=9

        warp_graph [shape=box, style="rounded,filled", fillcolor="#d0d0d0",
                    penwidth=1.2, label=<<B>WarpGraph</B><BR/><FONT POINT-SIZE="7">main API facade</FONT>>]
        reducer [shape=box, style="rounded,filled", fillcolor="#d0d0d0",
                 label=<JoinReducer>]
        patch_builder [shape=box, style="rounded,filled", fillcolor="#d0d0d0",
                       label=<PatchBuilderV2>]
        checkpoint_svc [shape=box, style="rounded,filled", fillcolor="#d0d0d0",
                        label=<CheckpointService>]
        query_builder [shape=box, style="rounded,filled", fillcolor="#d0d0d0",
                       label=<QueryBuilder>]
        traversal [shape=box, style="rounded,filled", fillcolor="#d0d0d0",
                   label=<LogicalTraversal>]

        // CRDT primitives
        crdt [shape=box, style="rounded,filled", fillcolor="#d0d0d0",
              label=<CRDTs<BR/><FONT POINT-SIZE="7">VersionVector, ORSet, LWW</FONT>>]
      }
    }
  }

  // === Outward-pointing arrows (adapter implements port) ===
  persistence_port -> git_adapter [style=dashed, penwidth=0.5, label=<implements>]
  codec_port -> cbor_codec [style=dashed, penwidth=0.5, label=<implements>]
  crypto_port -> web_crypto [style=dashed, penwidth=0.5, label=<implements>]
  clock_port -> clock_adapter [style=dashed, penwidth=0.5, label=<implements>]
  logger_port -> console_log [style=dashed, penwidth=0.5, label=<implements>]
  cache_port -> cas_cache [style=dashed, penwidth=0.5, label=<implements>]

  // IndexStoragePort is implemented via GitGraphAdapter (shared adapter)
  index_port -> git_adapter [style=dashed, penwidth=0.5, label=<via>]

  // Domain uses Ports
  warp_graph -> persistence_port [penwidth=0.5]
  warp_graph -> codec_port [penwidth=0.5]
  warp_graph -> crypto_port [penwidth=0.5]
  warp_graph -> clock_port [penwidth=0.5]
  warp_graph -> logger_port [penwidth=0.5]
  warp_graph -> index_port [penwidth=0.5]
  warp_graph -> cache_port [penwidth=0.5]

  // Internal domain relationships
  warp_graph -> reducer [penwidth=0.5, style=invis]
  warp_graph -> patch_builder [penwidth=0.5, style=invis]
}
