// Fig 5. Multi-Writer Convergence
// Style: Hybrid — Git chains + WARP state output
// Shows: Independent writer patch chains converging via JoinReducer

digraph multi_writer {
  bgcolor=transparent
  rankdir=TB
  newrank=true
  fontname="Times-Roman"
  fontsize=11
  label=<<I>Fig. 5.  Multi-Writer Convergence — independent chains, deterministic merge</I>>
  labelloc=b
  labeljust=c
  nodesep=0.4
  ranksep=0.7

  node [fontname="Times-Roman", fontsize=10, penwidth=0.8]
  edge [fontname="Times-Roman", fontsize=8, penwidth=0.8]

  // === Alice's patch chain ===
  subgraph cluster_alice {
    label=<<B>Alice</B>>
    labelloc=t
    style=rounded
    color="#606060"
    penwidth=0.8
    fontname="Times-Roman"
    fontsize=9

    Pa1 [shape=box, style="rounded,filled", fillcolor="#e8e8e8",
         label=<P<SUB>a1</SUB><BR/><FONT FACE="Courier" POINT-SIZE="7">L=1</FONT>>]
    Pa2 [shape=box, style="rounded,filled", fillcolor="#e8e8e8",
         label=<P<SUB>a2</SUB><BR/><FONT FACE="Courier" POINT-SIZE="7">L=2</FONT>>]
    Pa3 [shape=box, style="rounded,filled", fillcolor="#e8e8e8",
         label=<P<SUB>a3</SUB><BR/><FONT FACE="Courier" POINT-SIZE="7">L=4</FONT>>]

    Pa1 -> Pa2 -> Pa3
  }

  // === Bob's patch chain ===
  subgraph cluster_bob {
    label=<<B>Bob</B>>
    labelloc=t
    style=rounded
    color="#606060"
    penwidth=0.8
    fontname="Times-Roman"
    fontsize=9

    Pb1 [shape=box, style="rounded,filled", fillcolor="#e8e8e8",
         label=<P<SUB>b1</SUB><BR/><FONT FACE="Courier" POINT-SIZE="7">L=1</FONT>>]
    Pb2 [shape=box, style="rounded,filled", fillcolor="#e8e8e8",
         label=<P<SUB>b2</SUB><BR/><FONT FACE="Courier" POINT-SIZE="7">L=3</FONT>>]

    Pb1 -> Pb2
  }

  // === JoinReducer ===
  reducer [shape=none, margin=0, penwidth=1.2,
           label=<<TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
             <TR><TD COLSPAN="2"><B>JoinReducer</B></TD></TR>
             <TR><TD>OR-Set merge<BR/>(skeleton)</TD><TD>LWW merge<BR/>(attachments)</TD></TR>
           </TABLE>>]

  // === Materialized State ===
  state [shape=none, margin=0, penwidth=1.0,
         label=<<TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" BGCOLOR="#f0f0f0">
           <TR><TD COLSPAN="2"><B>WarpStateV5</B></TD></TR>
           <TR><TD><FONT FACE="Courier" POINT-SIZE="8">nodeAlive: ORSet</FONT></TD>
               <TD><FONT FACE="Courier" POINT-SIZE="8">edgeAlive: ORSet</FONT></TD></TR>
           <TR><TD><FONT FACE="Courier" POINT-SIZE="8">prop: Map&lt;LWW&gt;</FONT></TD>
               <TD><FONT FACE="Courier" POINT-SIZE="8">observedFrontier: VV</FONT></TD></TR>
         </TABLE>>]

  // === Sort step ===
  sort [shape=box, style="rounded,filled", fillcolor=white,
        label=<Sort by<BR/>Lamport>]

  // Convergence arrows
  Pa3 -> sort [penwidth=1.2]
  Pb2 -> sort [penwidth=1.2]
  sort -> reducer [penwidth=1.2]
  reducer -> state [penwidth=1.2]

  // No-coordination annotation
  no_coord [shape=plaintext, fontsize=8, fontname="Times-Roman",
            label=<no coordination<BR/>required between writers>]

  {rank=same; Pa1; Pb1}
  {rank=same; Pa3; Pb2}
  {rank=same; sort; no_coord}
}
