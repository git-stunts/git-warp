// Fig 6. Materialization Pipeline
// Style: Flow diagram (architectural)
// Shows: Left-to-right pipeline from writer refs to materialized state

digraph materialize_pipeline {
  bgcolor=transparent
  rankdir=LR
  fontname="Times-Roman"
  fontsize=11
  label=<<I>Fig. 6.  Materialization Pipeline — from refs to consistent state</I>>
  labelloc=b
  labeljust=c
  nodesep=0.5
  ranksep=0.6

  node [fontname="Times-Roman", fontsize=10, penwidth=0.8,
        shape=box, style="rounded,filled", fillcolor=white]
  edge [fontname="Times-Roman", fontsize=8, penwidth=1.0]

  // Pipeline stages
  refs [label=<Writer<BR/>Refs>, fillcolor="#f0f0f0"]
  walk [label=<Walk<BR/>Commit DAGs>]
  decode [label=<Decode<BR/>CBOR>]
  sort [label=<Sort by<BR/>Lamport>]

  // JoinReducer (larger, emphasized)
  reducer [label=<{<B>JoinReducer</B>|{
    OR-Set merge<BR/><FONT POINT-SIZE="8">(nodes, edges)</FONT> |
    LWW merge<BR/><FONT POINT-SIZE="8">(properties)</FONT>
  }}>, fillcolor="#d0d0d0", penwidth=1.2]

  // Output
  state [label=<{<B>WarpStateV5</B>|{
    <FONT FACE="Courier" POINT-SIZE="8">nodeAlive</FONT> |
    <FONT FACE="Courier" POINT-SIZE="8">edgeAlive</FONT> |
    <FONT FACE="Courier" POINT-SIZE="8">prop</FONT> |
    <FONT FACE="Courier" POINT-SIZE="8">frontier</FONT>
  }}>, fillcolor="#e8e8e8", penwidth=1.0]

  // Main pipeline flow
  refs -> walk -> decode -> sort -> reducer -> state

  // Checkpoint shortcut
  checkpoint [label=<Checkpoint<BR/><FONT POINT-SIZE="8">(if available)</FONT>>,
              fillcolor="#f0f0f0", style="rounded,dashed,filled"]

  refs -> checkpoint [style=dashed, penwidth=0.5, label=<shortcut>]
  checkpoint -> reducer [style=dashed, penwidth=0.5]

  // Patch count annotation
  complexity [shape=plaintext, fontsize=8,
              label=<O(P) — P = total patches across all writers>]
  {rank=same; state; complexity}
}
