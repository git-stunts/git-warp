<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Empty Graph: Current vs Fixed - Ref Management</title>
  <script src="https://unpkg.com/@viz-js/viz@3.2.4/lib/viz-standalone.js"></script>
  <style>
    :root {
      --current-color: #dc3545;
      --fixed-color: #28a745;
      --git-color: #f05033;
      --graph-color: #6f42c1;
    }

    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    .step {
      background: white;
      margin: 30px 0;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .step-header {
      background: #333;
      color: white;
      padding: 15px 20px;
      font-size: 18px;
    }

    .step-header .num {
      background: #666;
      padding: 4px 12px;
      border-radius: 4px;
      margin-right: 15px;
      font-weight: bold;
      font-size: 14px;
    }

    .step-code {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px 20px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      border-bottom: 1px solid #333;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    .current-side {
      border-right: 3px solid #eee;
    }

    .side-header {
      padding: 10px 20px;
      font-weight: bold;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .current-side .side-header {
      background: #ffebee;
      color: var(--current-color);
      border-bottom: 2px solid var(--current-color);
    }

    .fixed-side .side-header {
      background: #e8f5e9;
      color: var(--fixed-color);
      border-bottom: 2px solid var(--fixed-color);
    }

    .views {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    .view {
      padding: 15px;
      min-height: 180px;
      border-right: 1px solid #eee;
    }

    .view:last-child {
      border-right: none;
    }

    .view h5 {
      margin: 0 0 10px 0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
    }

    .view h5.git { color: var(--git-color); }
    .view h5.graph { color: var(--graph-color); }

    .graph-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 120px;
    }

    .graph-container svg {
      max-width: 100%;
      height: auto;
    }

    .explanation {
      background: #fff9e6;
      border-top: 1px solid #eee;
      padding: 15px 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .explanation h5 {
      margin: 0 0 8px 0;
      font-size: 12px;
      text-transform: uppercase;
    }

    .explanation .current h5 { color: var(--current-color); }
    .explanation .fixed h5 { color: var(--fixed-color); }

    .explanation p {
      margin: 0;
      font-size: 13px;
    }

    .danger {
      background: #ffebee;
      color: #c62828;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 10px;
    }

    .success {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 10px;
    }

    .intro {
      background: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .intro h3 { margin-top: 0; }

    .legend {
      display: flex;
      gap: 30px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }

    .legend-color.reachable { background: #ccffcc; border: 2px solid #009900; }
    .legend-color.dangling { background: #ffffcc; border: 2px solid #cc9900; }
    .legend-color.anchor { background: #cce5ff; border: 2px solid #0066cc; }
    .legend-color.ref { background: #ffcccc; border: 2px solid #cc0000; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th { background: #f5f5f5; }
  </style>
</head>
<body>
  <h1>Empty Graph: Current vs Fixed</h1>
  <p class="subtitle">Understanding the ref/GC problem and the proposed solution</p>

  <div class="intro">
    <h3>What You're Looking At</h3>
    <p>Each step shows <strong>4 panels</strong>:</p>
    <table>
      <tr>
        <th></th>
        <th>Git View</th>
        <th>Empty Graph View</th>
      </tr>
      <tr>
        <td><strong style="color:var(--current-color)">CURRENTLY</strong></td>
        <td>What Git sees (commits, refs, parent pointers)</td>
        <td>What your app sees (nodes with data)</td>
      </tr>
      <tr>
        <td><strong style="color:var(--fixed-color)">WITH FIX</strong></td>
        <td>What Git sees with proposed API</td>
        <td>What your app sees (should be the same!)</td>
      </tr>
    </table>

    <div class="legend">
      <div class="legend-item"><div class="legend-color reachable"></div> Reachable (GC safe)</div>
      <div class="legend-item"><div class="legend-color dangling"></div> Dangling (GC will delete!)</div>
      <div class="legend-item"><div class="legend-color anchor"></div> Anchor commit</div>
      <div class="legend-item"><div class="legend-color ref"></div> Git ref</div>
    </div>
  </div>

  <div class="intro" style="background:#fff8e1; border-color:#ffcc80;">
    <h3>The "Empty" in Empty Graph: The Empty Tree</h3>
    <p>Every Git commit points to a <strong>tree</strong> (a snapshot of files). In Empty Graph, every commit points to the same special tree: the <strong>empty tree</strong>.</p>
    <div style="background:#333;color:#d4d4d4;padding:15px;border-radius:6px;font-family:monospace;font-size:13px;margin:15px 0;">
      4b825dc642cb6eb9a060e54bf8d69288fbee4904  &larr; SHA of the empty tree (no files)
    </div>
    <p>This means:</p>
    <ul>
      <li><strong>No files</strong> - Your working directory stays empty (or has your regular code)</li>
      <li><strong>Data in messages</strong> - All your graph data is stored in commit messages</li>
      <li><strong>Invisible storage</strong> - The graph exists only in <code>.git/objects/</code></li>
    </ul>
    <p>In the Git View diagrams below, you'll see commits pointing to <code>EMPTY TREE</code>. This is the same tree for ALL commits - it's a constant.</p>
  </div>

  <!-- ============================================== -->
  <!-- STEP 1: Initialize                            -->
  <!-- ============================================== -->

  <div class="step">
    <div class="step-header">
      <span class="num">STEP 1</span>
      Initialize the graph
    </div>
    <div class="step-code">
// CURRENT API<br>
const graph = new EmptyGraph({ persistence: new GitGraphAdapter({ plumbing }) });<br><br>
// PROPOSED API<br>
const graph = await EmptyGraph.open('my-graph');
    </div>

    <div class="comparison">
      <div class="current-side">
        <div class="side-header">Currently</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=11];
                empty [label="(nothing)\nNo refs\nNo commits", shape=plaintext, fontcolor="#999"];
              }
            '></div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                bgcolor="transparent";
                empty [label="(empty graph)", shape=plaintext, fontcolor="#999"];
              }
            '></div>
          </div>
        </div>
      </div>

      <div class="fixed-side">
        <div class="side-header">With Fix</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=11];
                ref [label="refs/empty-graph/my-graph", shape=box, style=filled, fillcolor="#ffe0e0"];
                null [label="(empty)", shape=plaintext, fontcolor="#999"];
                ref -> null [style=dashed, color="#999"];
              }
            '></div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                bgcolor="transparent";
                empty [label="(empty graph)", shape=plaintext, fontcolor="#999"];
              }
            '></div>
          </div>
        </div>
      </div>
    </div>

    <div class="explanation">
      <div class="current">
        <h5>Current Behavior</h5>
        <p>Nothing happens in Git. No ref is created. The library is just an object in memory with no Git presence yet.</p>
      </div>
      <div class="fixed">
        <h5>Fixed Behavior</h5>
        <p>A ref is created at <code>refs/empty-graph/my-graph</code>. It doesn't point to anything yet, but the ref <em>exists</em> and is ready to anchor commits.</p>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- STEP 2: Create first node                     -->
  <!-- ============================================== -->

  <div class="step">
    <div class="step-header">
      <span class="num">STEP 2</span>
      Create first node
    </div>
    <div class="step-code">
const sha1 = await graph.createNode({ message: '{"type":"UserCreated","name":"Alice"}' });<br>
// Returns: "a1b2c3d4..."
    </div>

    <div class="comparison">
      <div class="current-side">
        <div class="side-header">Currently</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=11];
                a1b2 [label="a1b2c3", shape=circle, style=filled, fillcolor="#ffffcc", width=0.7];
                empty [label="EMPTY\nTREE\n4b825d...", shape=box, style=filled, fillcolor="#f0f0f0", fontsize=8, width=0.6];
                a1b2 -> empty [label="tree", fontsize=8, color="#999", style=dashed];
                warn [label="DANGLING!\nNo ref points here", shape=plaintext, fontcolor="#cc0000", fontsize=9];
                warn -> a1b2 [style=dashed, arrowhead=none, color="#cc0000"];
              }
            '></div>
            <div class="danger">Commit exists but is unreachable. GC will delete it!</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=10];
                n1 [label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
                  <tr><td bgcolor="#e6e6fa"><b>a1b2c3</b></td></tr>
                  <tr><td bgcolor="white">UserCreated<br/>name: Alice</td></tr>
                </table>>, shape=none];
              }
            '></div>
            <p style="font-size:11px;color:#666;text-align:center;">Works fine... for now</p>
          </div>
        </div>
      </div>

      <div class="fixed-side">
        <div class="side-header">With Fix</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=11];
                ref [label="refs/.../my-graph", shape=box, style=filled, fillcolor="#ffe0e0"];
                a1b2 [label="a1b2c3", shape=circle, style=filled, fillcolor="#ccffcc", width=0.7];
                empty [label="EMPTY\nTREE", shape=box, style=filled, fillcolor="#f0f0f0", fontsize=8, width=0.5];
                ref -> a1b2 [color="#009900", penwidth=2];
                a1b2 -> empty [label="tree", fontsize=8, color="#999", style=dashed];
              }
            '></div>
            <div class="success">Ref immediately updated to point to new commit.</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=10];
                n1 [label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
                  <tr><td bgcolor="#ccffcc"><b>a1b2c3</b></td></tr>
                  <tr><td bgcolor="white">UserCreated<br/>name: Alice</td></tr>
                </table>>, shape=none];
              }
            '></div>
            <p style="font-size:11px;color:#009900;text-align:center;">Same view, but now persistent!</p>
          </div>
        </div>
      </div>
    </div>

    <div class="explanation">
      <div class="current">
        <h5>Current Behavior</h5>
        <p><code>git commit-tree 4b825dc... -m "..."</code> creates a commit pointing to the empty tree. The commit exists in <code>.git/objects/</code>, but no ref points to it. Git considers it garbage.</p>
      </div>
      <div class="fixed">
        <h5>Fixed Behavior</h5>
        <p>Same commit creation, but immediately followed by <code>git update-ref</code> to point the ref at it. Now reachable: ref → commit → empty tree. GC-safe.</p>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- STEP 3: Create second node (with parent)      -->
  <!-- ============================================== -->

  <div class="step">
    <div class="step-header">
      <span class="num">STEP 3</span>
      Create second node (child of first)
    </div>
    <div class="step-code">
const sha2 = await graph.createNode({<br>
&nbsp;&nbsp;message: '{"type":"OrderPlaced","orderId":"order-123"}',<br>
&nbsp;&nbsp;parents: [sha1]<br>
});<br>
// Returns: "d4e5f6a7..."
    </div>

    <div class="comparison">
      <div class="current-side">
        <div class="side-header">Currently</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=LR;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=11];
                d4e5 [label="d4e5f6", shape=circle, style=filled, fillcolor="#ffffcc", width=0.6];
                a1b2 [label="a1b2c3", shape=circle, style=filled, fillcolor="#ffffcc", width=0.6];
                empty [label="EMPTY\nTREE", shape=box, style=filled, fillcolor="#f0f0f0", fontsize=8];
                d4e5 -> a1b2 [label="parent", fontsize=9];
                d4e5 -> empty [style=dashed, color="#999"];
                a1b2 -> empty [style=dashed, color="#999"];
                warn [label="BOTH DANGLING!", shape=plaintext, fontcolor="#cc0000", fontsize=9];
              }
            '></div>
            <div class="danger">Two commits, zero refs. Both will be deleted by GC.</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=10];
                n2 [label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
                  <tr><td bgcolor="#e6e6fa"><b>d4e5f6</b></td></tr>
                  <tr><td bgcolor="white">OrderPlaced</td></tr>
                </table>>, shape=none];
                n1 [label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
                  <tr><td bgcolor="#e6e6fa"><b>a1b2c3</b></td></tr>
                  <tr><td bgcolor="white">UserCreated</td></tr>
                </table>>, shape=none];
                n2 -> n1;
              }
            '></div>
          </div>
        </div>
      </div>

      <div class="fixed-side">
        <div class="side-header">With Fix</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=LR;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=11];
                ref [label="ref", shape=box, style=filled, fillcolor="#ffe0e0"];
                d4e5 [label="d4e5f6", shape=circle, style=filled, fillcolor="#ccffcc", width=0.6];
                a1b2 [label="a1b2c3", shape=circle, style=filled, fillcolor="#ccffcc", width=0.6];
                empty [label="EMPTY\nTREE", shape=box, style=filled, fillcolor="#f0f0f0", fontsize=8];
                ref -> d4e5 [color="#009900", penwidth=2];
                d4e5 -> a1b2 [label="parent", fontsize=9];
                d4e5 -> empty [style=dashed, color="#999"];
                a1b2 -> empty [style=dashed, color="#999"];
              }
            '></div>
            <div class="success">Ref moved to new tip. Both commits reachable.</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=10];
                n2 [label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
                  <tr><td bgcolor="#ccffcc"><b>d4e5f6</b></td></tr>
                  <tr><td bgcolor="white">OrderPlaced</td></tr>
                </table>>, shape=none];
                n1 [label=<<table border="0" cellborder="1" cellspacing="0" cellpadding="4">
                  <tr><td bgcolor="#ccffcc"><b>a1b2c3</b></td></tr>
                  <tr><td bgcolor="white">UserCreated</td></tr>
                </table>>, shape=none];
                n2 -> n1;
              }
            '></div>
          </div>
        </div>
      </div>
    </div>

    <div class="explanation">
      <div class="current">
        <h5>Current Behavior</h5>
        <p>Another dangling commit. Both point to the same empty tree (that's fine - the empty tree is always reachable). But d4e5f6 pointing to a1b2c3 as parent doesn't help - nothing points TO d4e5f6, so neither commit is reachable.</p>
      </div>
      <div class="fixed">
        <h5>Fixed Behavior</h5>
        <p>Ref is updated to point to the new tip (d4e5f6). Reachability: ref → d4e5f6 → a1b2c3 → (empty tree). Both commits reachable, GC-safe.</p>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- STEP 4: Create a branch (two children)        -->
  <!-- ============================================== -->

  <div class="step">
    <div class="step-header">
      <span class="num">STEP 4</span>
      Create a branch in the graph (second child of first node)
    </div>
    <div class="step-code">
const sha3 = await graph.createNode({<br>
&nbsp;&nbsp;message: '{"type":"OrderCancelled","reason":"Changed mind"}',<br>
&nbsp;&nbsp;parents: [sha1]  // Same parent as sha2!<br>
});<br>
// Returns: "g7h8i9j0..."
    </div>

    <div class="comparison">
      <div class="current-side">
        <div class="side-header">Currently</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=LR;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=10];
                d4e5 [label="d4e5f6", shape=circle, style=filled, fillcolor="#ffffcc", width=0.55];
                g7h8 [label="g7h8i9", shape=circle, style=filled, fillcolor="#ffffcc", width=0.55];
                a1b2 [label="a1b2c3", shape=circle, style=filled, fillcolor="#ffffcc", width=0.55];
                empty [label="EMPTY\nTREE", shape=box, style=filled, fillcolor="#f0f0f0", fontsize=7];
                d4e5 -> a1b2;
                g7h8 -> a1b2;
                d4e5 -> empty [style=dashed, color="#ccc"];
                g7h8 -> empty [style=dashed, color="#ccc"];
                a1b2 -> empty [style=dashed, color="#ccc"];
                warn [label="ALL DANGLING!", shape=plaintext, fontcolor="#cc0000", fontsize=9];
              }
            '></div>
            <div class="danger">Three commits, zero refs. Your "graph" is invisible to Git.</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9];
                n2 [label="OrderPlaced\nd4e5f6", shape=box, style="rounded,filled", fillcolor="white"];
                n3 [label="OrderCancelled\ng7h8i9", shape=box, style="rounded,filled", fillcolor="white"];
                n1 [label="UserCreated\na1b2c3", shape=box, style="rounded,filled", fillcolor="white"];
                n2 -> n1;
                n3 -> n1;
              }
            '></div>
            <p style="font-size:10px;color:#666;text-align:center;">Nice branching graph!<br/>(that will disappear)</p>
          </div>
        </div>
      </div>

      <div class="fixed-side">
        <div class="side-header">With Fix</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=LR;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=10];
                ref [label="ref", shape=box, style=filled, fillcolor="#ffe0e0"];
                anchor [label="ANCHOR", shape=circle, style=filled, fillcolor="#cce5ff", width=0.6];
                d4e5 [label="d4e5f6", shape=circle, style=filled, fillcolor="#ccffcc", width=0.55];
                g7h8 [label="g7h8i9", shape=circle, style=filled, fillcolor="#ccffcc", width=0.55];
                a1b2 [label="a1b2c3", shape=circle, style=filled, fillcolor="#ccffcc", width=0.55];
                empty [label="EMPTY\nTREE", shape=box, style=filled, fillcolor="#f0f0f0", fontsize=7];
                ref -> anchor [color="#009900", penwidth=2];
                anchor -> d4e5;
                anchor -> g7h8;
                d4e5 -> a1b2;
                g7h8 -> a1b2;
                anchor -> empty [style=dashed, color="#ccc"];
                d4e5 -> empty [style=dashed, color="#ccc"];
                g7h8 -> empty [style=dashed, color="#ccc"];
                a1b2 -> empty [style=dashed, color="#ccc"];
              }
            '></div>
            <div class="success">Anchor commit unifies both tips. All reachable.</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9];
                n2 [label="OrderPlaced\nd4e5f6", shape=box, style="rounded,filled", fillcolor="#ccffcc"];
                n3 [label="OrderCancelled\ng7h8i9", shape=box, style="rounded,filled", fillcolor="#ccffcc"];
                n1 [label="UserCreated\na1b2c3", shape=box, style="rounded,filled", fillcolor="#ccffcc"];
                n2 -> n1;
                n3 -> n1;
                note [label="(anchor hidden\nfrom app)", shape=plaintext, fontcolor="#999", fontsize=8];
              }
            '></div>
          </div>
        </div>
      </div>
    </div>

    <div class="explanation">
      <div class="current">
        <h5>Current Behavior</h5>
        <p>You now have a beautiful branching graph structure... that Git doesn't know exists. All three commits are "garbage" waiting to be collected.</p>
      </div>
      <div class="fixed">
        <h5>Fixed Behavior</h5>
        <p>When there are multiple tips (d4e5f6 and g7h8i9), an <strong>anchor commit</strong> is created with both as parents. The ref points to the anchor, making everything reachable. The anchor is internal infrastructure - your app doesn't see it.</p>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- STEP 5: Time passes, GC runs                  -->
  <!-- ============================================== -->

  <div class="step">
    <div class="step-header">
      <span class="num">STEP 5</span>
      Two weeks later... GC runs
    </div>
    <div class="step-code">
// Automatically, or manually via: git gc --prune=now
    </div>

    <div class="comparison">
      <div class="current-side">
        <div class="side-header">Currently</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=11];
                empty [label="(empty)\nAll commits DELETED", shape=plaintext, fontcolor="#cc0000"];
              }
            '></div>
            <div class="danger">Git deleted all "unreachable" objects. Your data is GONE.</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=10];
                err [label="graph.readNode(sha1)\n\nError: object not found", shape=box, style=filled, fillcolor="#ffcccc", fontname="monospace", fontsize=10];
              }
            '></div>
            <div class="danger">DATA LOSS. Unrecoverable.</div>
          </div>
        </div>
      </div>

      <div class="fixed-side">
        <div class="side-header">With Fix</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=LR;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=10];
                ref [label="ref", shape=box, style=filled, fillcolor="#ffe0e0"];
                anchor [label="ANCHOR", shape=circle, style=filled, fillcolor="#cce5ff", width=0.6];
                d4e5 [label="d4e5f6", shape=circle, style=filled, fillcolor="#ccffcc", width=0.55];
                g7h8 [label="g7h8i9", shape=circle, style=filled, fillcolor="#ccffcc", width=0.55];
                a1b2 [label="a1b2c3", shape=circle, style=filled, fillcolor="#ccffcc", width=0.55];
                ref -> anchor [color="#009900", penwidth=2];
                anchor -> d4e5;
                anchor -> g7h8;
                d4e5 -> a1b2;
                g7h8 -> a1b2;
                gc [label="GC runs...\nnothing deleted!", shape=plaintext, fontcolor="#009900", fontsize=9];
              }
            '></div>
            <div class="success">All commits reachable from ref. GC leaves them alone.</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9];
                n2 [label="OrderPlaced\nd4e5f6", shape=box, style="rounded,filled", fillcolor="#ccffcc"];
                n3 [label="OrderCancelled\ng7h8i9", shape=box, style="rounded,filled", fillcolor="#ccffcc"];
                n1 [label="UserCreated\na1b2c3", shape=box, style="rounded,filled", fillcolor="#ccffcc"];
                n2 -> n1;
                n3 -> n1;
              }
            '></div>
            <div class="success">Data intact. Works exactly as before.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="explanation">
      <div class="current">
        <h5>Current Behavior</h5>
        <p>Git's garbage collector deletes objects that aren't reachable from any ref. Your commits had no ref pointing to them (directly or indirectly), so they're gone. This might happen 2 weeks later, or immediately if someone runs <code>git gc --prune=now</code>.</p>
      </div>
      <div class="fixed">
        <h5>Fixed Behavior</h5>
        <p>The ref → anchor → commits chain means everything is reachable. GC checks reachability, finds all commits are reachable, and leaves them alone. Your data survives forever (or until you delete the ref).</p>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- STEP 6: Multiple Root Nodes                   -->
  <!-- ============================================== -->

  <div class="step">
    <div class="step-header">
      <span class="num">STEP 6</span>
      Multiple root nodes (independent starting points)
    </div>
    <div class="step-code">
// Task DAG with independent workstreams - no common ancestor<br>
const taskA = await graph.createNode({ message: '{"task":"Build API"}' });           // Root 1<br>
const taskB = await graph.createNode({ message: '{"task":"Design UI"}' });           // Root 2<br>
const taskC = await graph.createNode({ message: '{"task":"Write docs"}' });          // Root 3<br>
const taskA1 = await graph.createNode({ message: '{"task":"Auth endpoint"}', parents: [taskA] });<br>
const taskB1 = await graph.createNode({ message: '{"task":"Login page"}', parents: [taskB] });
    </div>

    <div class="comparison">
      <div class="current-side">
        <div class="side-header">Currently</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9];

                subgraph cluster_1 {
                  style=dashed; color="#cc0000";
                  A1 [label="Auth\nendpoint", shape=circle, style=filled, fillcolor="#ffffcc", width=0.5];
                  A [label="Build\nAPI", shape=circle, style=filled, fillcolor="#ffffcc", width=0.5];
                  A1 -> A;
                }

                subgraph cluster_2 {
                  style=dashed; color="#cc0000";
                  B1 [label="Login\npage", shape=circle, style=filled, fillcolor="#ffffcc", width=0.5];
                  B [label="Design\nUI", shape=circle, style=filled, fillcolor="#ffffcc", width=0.5];
                  B1 -> B;
                }

                subgraph cluster_3 {
                  style=dashed; color="#cc0000";
                  C [label="Write\ndocs", shape=circle, style=filled, fillcolor="#ffffcc", width=0.5];
                }

                empty [label="EMPTY TREE", shape=box, style=filled, fillcolor="#f0f0f0", fontsize=8];
                A -> empty [style=dashed, color="#ccc"];
                B -> empty [style=dashed, color="#ccc"];
                C -> empty [style=dashed, color="#ccc"];

                warn [label="3 DISCONNECTED\nDANGLING SUBGRAPHS!", shape=plaintext, fontcolor="#cc0000", fontsize=9];
              }
            '></div>
            <div class="danger">Three separate subgraphs, all dangling. No ref points to any of them.</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9, shape=box, style="rounded,filled", fillcolor="white"];

                A1 [label="Auth endpoint"];
                A [label="Build API"];
                B1 [label="Login page"];
                B [label="Design UI"];
                C [label="Write docs"];

                A1 -> A;
                B1 -> B;
              }
            '></div>
            <p style="font-size:10px;color:#666;text-align:center;">Three independent workstreams.<br/>Looks fine, but all will be deleted!</p>
          </div>
        </div>
      </div>

      <div class="fixed-side">
        <div class="side-header">With Fix</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9];

                ref [label="ref", shape=box, style=filled, fillcolor="#ffe0e0"];
                anchor [label="ANCHOR", shape=circle, style=filled, fillcolor="#cce5ff", width=0.6];

                A1 [label="Auth\nendpoint", shape=circle, style=filled, fillcolor="#ccffcc", width=0.5];
                A [label="Build\nAPI", shape=circle, style=filled, fillcolor="#ccffcc", width=0.5];
                B1 [label="Login\npage", shape=circle, style=filled, fillcolor="#ccffcc", width=0.5];
                B [label="Design\nUI", shape=circle, style=filled, fillcolor="#ccffcc", width=0.5];
                C [label="Write\ndocs", shape=circle, style=filled, fillcolor="#ccffcc", width=0.5];

                empty [label="EMPTY TREE", shape=box, style=filled, fillcolor="#f0f0f0", fontsize=8];

                ref -> anchor [color="#009900", penwidth=2];
                anchor -> A1 [color="#009900"];
                anchor -> B1 [color="#009900"];
                anchor -> C [color="#009900"];
                A1 -> A;
                B1 -> B;

                A -> empty [style=dashed, color="#ccc"];
                B -> empty [style=dashed, color="#ccc"];
                C -> empty [style=dashed, color="#ccc"];
              }
            '></div>
            <div class="success">Anchor has 3 parents (all tips). All subgraphs reachable!</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9, shape=box, style="rounded,filled", fillcolor="#ccffcc"];

                A1 [label="Auth endpoint"];
                A [label="Build API"];
                B1 [label="Login page"];
                B [label="Design UI"];
                C [label="Write docs"];

                A1 -> A;
                B1 -> B;
              }
            '></div>
            <p style="font-size:10px;color:#009900;text-align:center;">Same view - anchor is hidden.<br/>All three workstreams persisted!</p>
          </div>
        </div>
      </div>
    </div>

    <div class="explanation">
      <div class="current">
        <h5>Current Behavior</h5>
        <p>Three independent subgraphs with three root nodes. None are connected to each other. Since no ref points to any of them, ALL commits in ALL subgraphs are garbage. Your entire task system vanishes on GC.</p>
      </div>
      <div class="fixed">
        <h5>Fixed Behavior</h5>
        <p>The anchor commit has <strong>all tips</strong> as parents (A1, B1, C). Reachability: ref → anchor → tips → roots. Even though the subgraphs are disconnected from each other, they're all connected to the anchor. One ref protects everything.</p>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- STEP 7: Multiple roots later merge            -->
  <!-- ============================================== -->

  <div class="step">
    <div class="step-header">
      <span class="num">STEP 7</span>
      Independent roots that later merge
    </div>
    <div class="step-code">
// Later, the workstreams converge for integration<br>
const integration = await graph.createNode({<br>
&nbsp;&nbsp;message: '{"task":"Integration testing"}',<br>
&nbsp;&nbsp;parents: [taskA1, taskB1, taskC]  // Merges all three workstreams!<br>
});
    </div>

    <div class="comparison">
      <div class="current-side">
        <div class="side-header">Currently</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9];

                integration [label="Integration", shape=circle, style=filled, fillcolor="#ffffcc", width=0.6];
                A1 [label="Auth", shape=circle, style=filled, fillcolor="#ffffcc", width=0.45];
                A [label="API", shape=circle, style=filled, fillcolor="#ffffcc", width=0.45];
                B1 [label="Login", shape=circle, style=filled, fillcolor="#ffffcc", width=0.45];
                B [label="UI", shape=circle, style=filled, fillcolor="#ffffcc", width=0.45];
                C [label="Docs", shape=circle, style=filled, fillcolor="#ffffcc", width=0.45];

                integration -> A1 -> A;
                integration -> B1 -> B;
                integration -> C;

                warn [label="ALL STILL\nDANGLING!", shape=plaintext, fontcolor="#cc0000", fontsize=9];
              }
            '></div>
            <div class="danger">Now connected in Git too - but still no ref. Still all garbage.</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9, shape=box, style="rounded,filled", fillcolor="white"];

                integration [label="Integration\ntesting", fillcolor="#ffe6cc"];
                A1 [label="Auth endpoint"];
                A [label="Build API"];
                B1 [label="Login page"];
                B [label="Design UI"];
                C [label="Write docs"];

                integration -> A1 -> A;
                integration -> B1 -> B;
                integration -> C;
              }
            '></div>
            <p style="font-size:10px;text-align:center;">Beautiful merge node!<br/>Still gonna be deleted.</p>
          </div>
        </div>
      </div>

      <div class="fixed-side">
        <div class="side-header">With Fix</div>
        <div class="views">
          <div class="view">
            <h5 class="git">Git View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9];

                ref [label="ref", shape=box, style=filled, fillcolor="#ffe0e0"];

                integration [label="Integration", shape=circle, style=filled, fillcolor="#ccffcc", width=0.6];
                A1 [label="Auth", shape=circle, style=filled, fillcolor="#ccffcc", width=0.45];
                A [label="API", shape=circle, style=filled, fillcolor="#ccffcc", width=0.45];
                B1 [label="Login", shape=circle, style=filled, fillcolor="#ccffcc", width=0.45];
                B [label="UI", shape=circle, style=filled, fillcolor="#ccffcc", width=0.45];
                C [label="Docs", shape=circle, style=filled, fillcolor="#ccffcc", width=0.45];

                ref -> integration [color="#009900", penwidth=2];
                integration -> A1 -> A;
                integration -> B1 -> B;
                integration -> C;
              }
            '></div>
            <div class="success">Single tip now - ref points directly to it. No anchor needed!</div>
          </div>
          <div class="view">
            <h5 class="graph">Empty Graph View</h5>
            <div class="graph-container" data-dot='
              digraph {
                rankdir=TB;
                bgcolor="transparent";
                node [fontname="Helvetica", fontsize=9, shape=box, style="rounded,filled", fillcolor="#ccffcc"];

                integration [label="Integration\ntesting", fillcolor="#c8e6c9"];
                A1 [label="Auth endpoint"];
                A [label="Build API"];
                B1 [label="Login page"];
                B [label="Design UI"];
                C [label="Write docs"];

                integration -> A1 -> A;
                integration -> B1 -> B;
                integration -> C;
              }
            '></div>
            <p style="font-size:10px;color:#009900;text-align:center;">Same beautiful merge.<br/>Now it's permanent!</p>
          </div>
        </div>
      </div>
    </div>

    <div class="explanation">
      <div class="current">
        <h5>Current Behavior</h5>
        <p>The "Integration" node merges all three workstreams by having them as parents. In Git, this now forms a connected DAG. But it's STILL dangling - no ref points to Integration, so the entire graph is garbage.</p>
      </div>
      <div class="fixed">
        <h5>Fixed Behavior</h5>
        <p>Now there's only one tip (Integration), so the ref can point directly to it - no anchor commit needed! All three root nodes are reachable via: ref → Integration → (A1, B1, C) → (A, B). The merge node naturally unifies everything.</p>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- SUMMARY                                       -->
  <!-- ============================================== -->

  <div class="intro" style="margin-top:40px;">
    <h3>Summary: The Key Difference</h3>
    <table>
      <tr>
        <th></th>
        <th style="color:var(--current-color)">Currently</th>
        <th style="color:var(--fixed-color)">With Fix</th>
      </tr>
      <tr>
        <td><strong>On init</strong></td>
        <td>Nothing</td>
        <td>Create ref</td>
      </tr>
      <tr>
        <td><strong>On createNode</strong></td>
        <td>Create commit (dangling)</td>
        <td>Create commit + update ref (or anchor)</td>
      </tr>
      <tr>
        <td><strong>Multiple tips</strong></td>
        <td>Multiple dangling commits</td>
        <td>Anchor commit unifies them</td>
      </tr>
      <tr>
        <td><strong>Multiple roots</strong></td>
        <td>Disconnected dangling subgraphs</td>
        <td>Anchor reaches all tips → all roots reachable</td>
      </tr>
      <tr>
        <td><strong>Roots that merge</strong></td>
        <td>Still dangling (no ref)</td>
        <td>Merge node becomes single tip → ref points to it</td>
      </tr>
      <tr>
        <td><strong>After GC</strong></td>
        <td>DATA LOSS</td>
        <td>Data intact</td>
      </tr>
      <tr>
        <td><strong>User responsibility</strong></td>
        <td>Must manually manage refs</td>
        <td>Automatic (or explicit via Writer API)</td>
      </tr>
    </table>

    <h4 style="margin-top:25px;">The Empty Tree</h4>
    <p>Every commit points to a tree. In Empty Graph, it's always the same tree: <code>4b825dc642cb6eb9a060e54bf8d69288fbee4904</code> (the empty tree with no files). This is why your working directory has no files from the graph - all data lives in commit messages.</p>

    <h4 style="margin-top:25px;">The Core Problem</h4>
    <p>Git reachability flows: <strong>ref → commit → parent → parent → ... → empty tree</strong></p>
    <p>The empty tree is always reachable (it's a well-known constant). But your commits pointing TO the empty tree doesn't make THEM reachable. Something must point <em>to</em> your commits. Currently, nothing does.</p>
  </div>

  <script>
    Viz.instance().then(viz => {
      document.querySelectorAll('[data-dot]').forEach(container => {
        const dot = container.getAttribute('data-dot');
        try {
          const svg = viz.renderSVGElement(dot);
          container.innerHTML = '';
          container.appendChild(svg);
        } catch (err) {
          container.innerHTML = `<pre style="color:red;font-size:10px;">${err.message}</pre>`;
        }
      });
    });
  </script>
</body>
</html>
