# Backlog

Items noticed during development that are worth addressing but were out of scope at the time.

---

## CI / Build

### B-CI-1: `type-firewall` and `lint` jobs are nearly identical

The `type-firewall` job runs Gates 1-5. The `lint` job runs the same 5 gates plus `npm audit`. This means every CI run does all type checks twice. Options:

- **Merge** them into one job (add `npm audit` to `type-firewall`, drop `lint`).
- **Make `lint` depend on `type-firewall`** via `needs:` so it only runs audit.
- Keep both if the intent is redundancy for required-status-check flexibility.

**File:** `.github/workflows/ci.yml`

### B-CI-2: Surface validator emits 80 warnings that mask signal

`npm run typecheck:surface` currently produces 80 `WARN:` lines for type-only exports not in the manifest. This noise buries the `PASS`/`FAIL` verdict. Options:

- Add a `--quiet` flag to suppress type-only warnings.
- Add a `--strict-types` flag that promotes type-only warnings to errors (for when type-only exports should also be in the manifest).
- At minimum, move warnings to a summary count instead of one line per export.

**File:** `scripts/check-dts-surface.js`

### B-CI-3: Consider a type-only export manifest section

The manifest (`contracts/type-surface.m8.json`) tracks 70 value exports but ignores 80 type-only exports. If a type is accidentally removed from `index.d.ts`, no gate catches it. A `typeExports` section in the manifest would close this gap.

**Files:** `contracts/type-surface.m8.json`, `scripts/check-dts-surface.js`

---

## Surface Validator Robustness

### B-SURF-1: Missing `declare` support for `interface` and `type` regexes

The M2 fix added `(?:declare\s+)?` to `class`, `const|function`, and `default class` regexes, but `export interface` (line 104) and `export type` (line 108) don't have it. While `.d.ts` files typically use `export interface` directly rather than `export declare interface`, the inconsistency is a latent bug if declaration files are generated by tools that emit `export declare interface`.

**File:** `scripts/check-dts-surface.js`, lines 104, 108

### B-SURF-2: No unit tests for the surface validator

`check-dts-surface.js` is a CI gate with 7+ regexes but zero unit tests. The `extractJsExports` and `extractDtsExports` functions should have test cases covering:

- `export { type Foo }` and `export { type Foo as Bar }`
- `export declare class`, `export declare const`, `export declare function`
- `export { A, B, C }` with comments interspersed
- Multiline export blocks
- Edge cases: `export declare default class`, `export declare namespace` (unsupported — should it be?)

**File:** new `test/unit/scripts/check-dts-surface.test.js`

### B-SURF-3: Duplicate `export { ... }` parsing logic

`extractJsExports` and `extractDtsExports` both contain nearly identical code for parsing `export { A, B as C }` blocks with `type` stripping and `as` handling. Extract to a shared `parseExportBlock(content: string): Set<string>` helper.

**File:** `scripts/check-dts-surface.js`

### B-SURF-4: `extractJsExports` doesn't handle standalone export declarations

`extractJsExports` only handles `export { ... }` blocks and `export default`. If `index.js` ever uses `export const foo = ...` or `export function bar()`, they'd be missed silently. Not currently a problem (index.js uses re-export blocks), but fragile.

**File:** `scripts/check-dts-surface.js`

### B-SURF-5: `extractDtsExports` doesn't handle `export declare namespace`

TypeScript namespaces (`export declare namespace Foo`) are not matched by any regex. If the `.d.ts` ever adds namespace exports, they'd be invisible to the validator.

**File:** `scripts/check-dts-surface.js`

---

## Type Surface / Consumer Tests

### B-TYPE-1: Consumer test doesn't exercise type-only imports

The consumer test imports many types via `import type { ... }` but doesn't actually use most of them beyond declaring variables. Some types (e.g., `ObserverConfig`, `GCPolicyConfig`) are used as function argument/return annotations, which is good. But others like `OpOutcome`, `TraversalDirection`, `LogLevelValue` aren't imported or tested at all. A follow-up pass could ensure every exported type is at least assignable.

**File:** `test/type-check/consumer.ts`

### B-TYPE-2: 4 `index.js` exports not in manifest

The surface check shows `Manifest entries: 70` vs `index.js exports: 66`. This means 4 manifest entries don't appear in `index.js` — they might be type-only re-exports or stale entries. Worth auditing the manifest for drift.

**Files:** `contracts/type-surface.m8.json`, `index.js`

### B-TYPE-3: Establish test-file wildcard ratchet

`ts-policy-check.js` only scans `src/`, `bin/`, and `scripts/` by design — test files are excluded. This means `@type {any}` usages across test files are unchecked. Options:
- Add a separate ratchet for test files with a higher threshold
- Add per-file caps to prevent individual test files from growing unbounded
- Document the exclusion as intentional and accept it

**Files:** `scripts/ts-policy-check.js`

---

## Feature: Content Attachment

### B-FEAT-1: ~~Implement content attachment~~ DONE (v11.5.0)

Shipped in v11.5.0. See `docs/specs/CONTENT_ATTACHMENT.md` and CHANGELOG.

### B-FEAT-2: Determinism fuzzer for tree construction

Content blob tree entries are sorted by filename for deterministic tree OIDs. A property-based test should randomize:
- content blob insertion order in `PatchBuilderV2`
- content OID iteration order in `CheckpointService.createV5()`

and verify the resulting tree OID is identical regardless of insertion order. This would catch any accidental order-dependence in tree construction.

**Files:** new test in `test/unit/domain/services/`

### B-FEAT-3: Reconcile Map vs Record asymmetry in getNodeProps/getEdgeProps

`getNodeProps()` returns a `Map<string, unknown>` while `getEdgeProps()` returns a plain `Record<string, unknown>`. This forces callers to use `.get()` for node props and `[key]` for edge props — an easy source of bugs. Options:
- Both return Map (breaking change for edge prop consumers)
- Both return Record (breaking change for node prop consumers)
- Keep both, document the asymmetry prominently

**Files:** `src/domain/warp/query.methods.js`, `src/domain/WarpGraph.js`

---

## Documentation Quality

### B-DOC-1: Add markdownlint to CI

Add a markdownlint check to the CI pipeline to catch MD040 (missing code fence language tags) and similar doc issues automatically. Currently these are only caught by CodeRabbit review, which is slow and non-blocking.

**File:** `.github/workflows/ci.yml`

### B-DOC-2: Add a code sample linter for markdown files

Syntax-check JS/TS code blocks embedded in markdown files (specs, guides, etc.) to catch issues like duplicate `const` declarations, TDZ errors, and other syntax errors before they reach review. Could use `eslint-plugin-markdown` (runs ESLint natively on fenced blocks) or a custom script that extracts code blocks and pipes them through `eslint --stdin`.

**Files:** new script or CI step, `docs/**/*.md`

---

## Developer Experience

### B-DX-1: Pre-push hook runs full test suite

The pre-push hook runs lint + all 5 type gates + all 3803 unit tests (~24s). For rapid iteration, a `--quick` pre-push mode that skips unit tests (type gates only, ~5s) would improve DX. The full suite would still run in CI.

**File:** `scripts/pre-push-hook.sh` or equivalent

---
