# Backlog

Items noticed during development that are worth addressing but were out of scope at the time.

---

## CI / Build

### B-CI-1: `type-firewall` and `lint` jobs are nearly identical

The `type-firewall` job runs Gates 1-5. The `lint` job runs the same 5 gates plus `npm audit`. This means every CI run does all type checks twice. Options:

- **Merge** them into one job (add `npm audit` to `type-firewall`, drop `lint`).
- **Make `lint` depend on `type-firewall`** via `needs:` so it only runs audit.
- Keep both if the intent is redundancy for required-status-check flexibility.

**File:** `.github/workflows/ci.yml`

### B-CI-2: Surface validator emits 80 warnings that mask signal

`npm run typecheck:surface` currently produces 80 `WARN:` lines for type-only exports not in the manifest. This noise buries the `PASS`/`FAIL` verdict. Options:

- Add a `--quiet` flag to suppress type-only warnings.
- Add a `--strict-types` flag that promotes type-only warnings to errors (for when type-only exports should also be in the manifest).
- At minimum, move warnings to a summary count instead of one line per export.

**File:** `scripts/check-dts-surface.js`

### B-CI-3: Consider a type-only export manifest section

The manifest (`contracts/type-surface.m8.json`) tracks 70 value exports but ignores 80 type-only exports. If a type is accidentally removed from `index.d.ts`, no gate catches it. A `typeExports` section in the manifest would close this gap.

**Files:** `contracts/type-surface.m8.json`, `scripts/check-dts-surface.js`

---

## Surface Validator Robustness

### B-SURF-1: Missing `declare` support for `interface` and `type` regexes

The M2 fix added `(?:declare\s+)?` to `class`, `const|function`, and `default class` regexes, but `export interface` (line 104) and `export type` (line 108) don't have it. While `.d.ts` files typically use `export interface` directly rather than `export declare interface`, the inconsistency is a latent bug if declaration files are generated by tools that emit `export declare interface`.

**File:** `scripts/check-dts-surface.js`, lines 104, 108

### B-SURF-2: No unit tests for the surface validator

`check-dts-surface.js` is a CI gate with 7+ regexes but zero unit tests. The `extractJsExports` and `extractDtsExports` functions should have test cases covering:

- `export { type Foo }` and `export { type Foo as Bar }`
- `export declare class`, `export declare const`, `export declare function`
- `export { A, B, C }` with comments interspersed
- Multiline export blocks
- Edge cases: `export declare default class`, `export declare namespace` (unsupported — should it be?)

**File:** new `test/unit/scripts/check-dts-surface.test.js`

### B-SURF-3: Duplicate `export { ... }` parsing logic

`extractJsExports` and `extractDtsExports` both contain nearly identical code for parsing `export { A, B as C }` blocks with `type` stripping and `as` handling. Extract to a shared `parseExportBlock(content: string): Set<string>` helper.

**File:** `scripts/check-dts-surface.js`

### B-SURF-4: `extractJsExports` doesn't handle standalone export declarations

`extractJsExports` only handles `export { ... }` blocks and `export default`. If `index.js` ever uses `export const foo = ...` or `export function bar()`, they'd be missed silently. Not currently a problem (index.js uses re-export blocks), but fragile.

**File:** `scripts/check-dts-surface.js`

### B-SURF-5: `extractDtsExports` doesn't handle `export declare namespace`

TypeScript namespaces (`export declare namespace Foo`) are not matched by any regex. If the `.d.ts` ever adds namespace exports, they'd be invisible to the validator.

**File:** `scripts/check-dts-surface.js`

---

## Type Surface / Consumer Tests

### B-TYPE-1: Consumer test doesn't exercise type-only imports

The consumer test imports many types via `import type { ... }` but doesn't actually use most of them beyond declaring variables. Some types (e.g., `ObserverConfig`, `GCPolicyConfig`) are used as function argument/return annotations, which is good. But others like `OpOutcome`, `TraversalDirection`, `LogLevelValue` aren't imported or tested at all. A follow-up pass could ensure every exported type is at least assignable.

**File:** `test/type-check/consumer.ts`

### B-TYPE-2: 4 `index.js` exports not in manifest

The surface check shows `Manifest entries: 70` vs `index.js exports: 66`. This means 4 manifest entries don't appear in `index.js` — they might be type-only re-exports or stale entries. Worth auditing the manifest for drift.

**Files:** `contracts/type-surface.m8.json`, `index.js`

---

## Feature: Content Attachment

### B-FEAT-1: Implement content attachment (`Atom(p)` payloads on nodes)

Full spec in `docs/specs/CONTENT_ATTACHMENT.md`. Proposal to attach content-addressed blobs to graph nodes as first-class payloads, bridging git-warp's flat key-value properties to the paper's `α(v)` vertex attachment model.

**Core idea:** Store blobs in the Git object store (already a CAS), reference them via a `_content` property on nodes. This gets CRDT merge (LWW on the SHA), time-travel (`materialize({ ceiling })`), and observer scoping for free — zero changes to the CRDT model.

**Key decisions needed:**

- **API shape:** Property convention only (zero new API) vs dedicated `patch.attachContent()` / `graph.getContent()` methods vs hybrid. Spec recommends hybrid.
- **Metadata properties:** Whether to store `_content.size`, `_content.mime`, `_content.encoding` at the substrate level or leave to consumers.
- **Dependency:** `git-cas` package or equivalent `git hash-object -w` / `git cat-file blob` via existing plumbing.
- **Edge attachments:** Deferred to v2 unless trivially included. Same mechanism — `_content` property on edges.

**Out of scope (future):** Nested WARP attachments (where `α(v)` is itself a full WARP graph, not just an atom), content-level merge, MIME handling, content GC protection.

**Spec:** `docs/specs/CONTENT_ATTACHMENT.md`

---

## Developer Experience

### B-DX-1: Pre-push hook runs full test suite

The pre-push hook runs lint + all 5 type gates + all 3803 unit tests (~24s). For rapid iteration, a `--quick` pre-push mode that skips unit tests (type gates only, ~5s) would improve DX. The full suite would still run in CI.

**File:** `scripts/pre-push-hook.sh` or equivalent

---
